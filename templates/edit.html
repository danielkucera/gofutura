<!DOCTYPE html>
<html>
<head>
	<title>Futura Interface</title>
	<style>
		* { font-family: Arial, sans-serif; }
		body { margin: 20px; background: #f5f5f5; }
		h1 { color: #333; }
		.container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
		.section { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f9f9f9; }
		.section h2 { margin-top: 0; color: #007bff; }
		.form-group { margin: 12px 0; }
		label { display: block; font-weight: bold; margin-bottom: 4px; color: #333; }
		input[type="text"], input[type="number"], select { padding: 8px; width: 130px; border: 1px solid #ddd; border-radius: 4px; }
		input[type="checkbox"] { margin-right: 8px; }
		button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
		button:hover { background: #218838; }
		.status { margin-top: 20px; padding: 10px; border-radius: 4px; }
		.status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
		.status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
		.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
		.invalidate-line { display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }
		.invalidate-label { font-weight: 600; }
		.field-row { display: flex; align-items: center; gap: 8px; margin: 6px 0; }
		.field-row .field-label { min-width: 120px; font-weight: 700; }
		.field-row input[type="number"],
		.field-row select { width: 130px; }
			.alfa-card { padding: 8px; border: 1px solid #eee; border-radius: 6px; margin: 6px 0; background: #fff; }

			/* Ventilation visual (smaller boxes, adjusted positions) */
			.section.ventilation { border-left-width: 8px; padding-left: 18px; }
			.vent-wrapper { position: relative; max-width: 560px; margin: 6px auto 18px; }
			.vent-img { width: 100%; height: auto; display: block; border-radius: 8px; }
			.vent-box { position: absolute; background: white; padding: 8px 10px; border-radius: 10px; box-shadow: 0 6px 14px rgba(0,0,0,0.06); min-width: 110px; text-align: left; z-index: 20; }
			.vent-box .label { color: #666; font-size: 11px; margin-bottom: 6px; }
			.vent-box .temp { font-weight: 800; font-size: 18px; line-height:1; }
			.vent-box .humi { color: #007bff; font-weight: 700; font-size: 13px; }
			/* desktop positions */
			.vent-outside { left: -2%; top: -6%; }
			.vent-supply { right: -19%; top: -6%; transform: translateX(-6%); }
			.vent-exhaust { left: -16%; top: 23%; }
			.vent-return { right: -15%; top: 23%; transform: translateX(6%); }
			/* tighter on narrow screens */
			@media (max-width:700px) {
				.vent-box { min-width: 100px; padding: 8px; font-size: 13px; }
				.vent-outside { left: -2%; top: -6%; }
				.vent-supply { right: -19%; top: -6%; transform: translateX(-4%); }
				.vent-exhaust { left: -16%; top: 23%; }
				.vent-return { right: -15%; top: 23%; transform: translateX(4%); }
			}
			
	</style>
</head>
<body>
	<div class="container">
		<h1>Futura Interface</h1>
		<p>Edit holding registers and apply changes to the device.</p>

		<form id="editForm">
			<div class="grid">
				<!-- Ventilation (first panel) -->
				<div class="section ventilation">
					<h2>Ventilation</h2>
					<div class="vent-wrapper">
						<img class="vent-img" src="/static/img_futura_ventilation.png" alt="Ventilation diagram">
						<div class="vent-box vent-outside">
							<div class="label">Ambient air</div>
							<div class="temp"><span id="vent-outside-temp">—</span></div>
							<div class="humi"><span id="vent-outside-humi">—</span> %</div>
						</div>
						<div class="vent-box vent-supply">
							<div class="label">Fresh air</div>
							<div class="temp"><span id="vent-supply-temp">—</span></div>
							<div class="humi"><span id="vent-supply-humi">—</span> %</div>
						</div>
						<div class="vent-box vent-exhaust">
							<div class="label">Waste air</div>
							<div class="temp"><span id="vent-exhaust-temp">—</span></div>
							<div class="humi"><span id="vent-exhaust-humi">—</span> %</div>
						</div>
						<div class="vent-box vent-return">
							<div class="label">Indoor air</div>
							<div class="temp"><span id="vent-return-temp">—</span></div>
							<div class="humi"><span id="vent-return-humi">—</span> %</div>
						</div>
					</div>
				</div>

				<!-- Ventilation & Functions -->
				<div class="section">
					<h2>Ventilation & Functions</h2>
					<div class="form-group">
						<label for="FuncVentilation">Ventilation Level (0-6):</label>
						<input type="number" id="FuncVentilation" name="FuncVentilation" min="0" max="6">
					</div>
					<div class="form-group">
						<label for="FuncBoostTm">Boost Timer (seconds):</label>
						<input type="number" id="FuncBoostTm" name="FuncBoostTm" min="0" max="7200">
					</div>
					<div class="form-group">
						<label for="FuncCirculationTm">Circulation Timer (seconds):</label>
						<input type="number" id="FuncCirculationTm" name="FuncCirculationTm" min="0" max="7200">
					</div>
					<div class="form-group">
						<label for="FuncPartyTm">Party Timer (seconds):</label>
						<input type="number" id="FuncPartyTm" name="FuncPartyTm" min="0" max="28800">
					</div>
					<div class="form-group">
						<label for="FuncNightTm">Night Timer (seconds):</label>
						<input type="number" id="FuncNightTm" name="FuncNightTm" min="0" max="7200">
					</div>
					<div class="form-group">
						<label for="FuncOverpressureTm">Overpressure Timer (seconds):</label>
						<input type="number" id="FuncOverpressureTm" name="FuncOverpressureTm" min="0" max="7200">
					</div>
				</div>

				<!-- Configuration -->
				<div class="section">
					<h2>Configuration</h2>
					<div class="form-group">
						<label for="CfgTempSet">Target Temperature (°C):</label>
						<input type="number" id="CfgTempSet" name="CfgTempSet" step="0.1" min="-20" max="50">
					</div>
					<div class="form-group">
						<label for="CfgHumiSet">Target Humidity (%):</label>
						<input type="number" id="CfgHumiSet" name="CfgHumiSet" step="0.1" min="0" max="100">
					</div>
					<div class="form-group">
						<label><input type="checkbox" id="CfgBypassEnable" name="CfgBypassEnable"> Enable Bypass</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" id="CfgHeatingEnable" name="CfgHeatingEnable"> Enable Heating</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" id="CfgCoolingEnable" name="CfgCoolingEnable"> Enable Cooling</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" id="CfgComfortEnable" name="CfgComfortEnable"> Enable Comfort Control</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" id="FuncTimeProg" name="FuncTimeProg"> Enable Time Program</label>
					</div>
					<div class="form-group">
						<label><input type="checkbox" id="FuncAntiradon" name="FuncAntiradon"> Enable Radon Protection</label>
					</div>
				</div>

				<!-- HVAC Settings -->
				<div class="section">
					<h2>HVAC Settings</h2>
					<div class="form-group">
						<label for="VzvCBPriorityControl">Coolbreeze Priority (0=Temp, 1=CO2):</label>
						<select id="VzvCBPriorityControl" name="VzvCBPriorityControl">
							<option value="0">Temperature</option>
							<option value="1">CO2</option>
						</select>
					</div>
					<div class="form-group">
						<label><input type="checkbox" id="VzvKitchenhoodNormallyOpen" name="VzvKitchenhoodNormallyOpen"> Hood Normally Open</label>
					</div>
					<div class="form-group">
						<label for="VzvBoostVolumePerRun">Boost Volume (m³/h):</label>
						<input type="number" id="VzvBoostVolumePerRun" name="VzvBoostVolumePerRun" min="50" max="150">
					</div>
					<div class="form-group">
						<label for="VzvKitchenhoodNormallyOpenVolume">Hood Volume (m³/h):</label>
						<input type="number" id="VzvKitchenhoodNormallyOpenVolume" name="VzvKitchenhoodNormallyOpenVolume" min="50" max="150">
					</div>
				</div>

				<!-- Main Unit -->
				<div class="section">
					<h2>Main Unit</h2>
					<div id="mainUnitContainer">Loading main unit data...</div>
				</div>

				<div id="alfaContainer" style="display: contents;">Loading ALFA data...<br></div>

                <div id="extSensContainer" style="display: contents;">Loading external sensors...<br></div>

                <div id="extBtnContainer" style="display: contents;">Loading external buttons...<br></div>

			</div>

		</form>

		<div id="status"></div>
	</div>

	<script>
		// Load current values
		async function loadValues() {
			try {
				const res = await fetch('/api/read-holding');
				const data = await res.json();
				// cache holding data for later use when dynamic inputs are created
				window.holdingData = data;
				// Map data to form fields
				document.getElementById('FuncVentilation').value = data.FuncVentilation || '';
				document.getElementById('FuncBoostTm').value = data.FuncBoostTm || '';
				document.getElementById('FuncCirculationTm').value = data.FuncCirculationTm || '';
				document.getElementById('FuncPartyTm').value = data.FuncPartyTm || '';
				document.getElementById('FuncNightTm').value = data.FuncNightTm || '';
				document.getElementById('FuncOverpressureTm').value = data.FuncOverpressureTm || '';
				document.getElementById('CfgTempSet').value = data.CfgTempSet || '';
				document.getElementById('CfgHumiSet').value = data.CfgHumiSet || '';
				document.getElementById('CfgBypassEnable').checked = data.CfgBypassEnable === 1;
				document.getElementById('CfgHeatingEnable').checked = data.CfgHeatingEnable === 1;
				document.getElementById('CfgCoolingEnable').checked = data.CfgCoolingEnable === 1;
				document.getElementById('CfgComfortEnable').checked = data.CfgComfortEnable === 1;
				document.getElementById('FuncTimeProg').checked = data.FuncTimeProg === 1;
				document.getElementById('FuncAntiradon').checked = data.FuncAntiradon === 1;
				document.getElementById('VzvCBPriorityControl').value = data.VzvCBPriorityControl || '0';
				document.getElementById('VzvKitchenhoodNormallyOpen').checked = data.VzvKitchenhoodNormallyOpen === 1;
				document.getElementById('VzvBoostVolumePerRun').value = data.VzvBoostVolumePerRun || '';
				document.getElementById('VzvKitchenhoodNormallyOpenVolume').value = data.VzvKitchenhoodNormallyOpenVolume || '';
				// populate ext sensor correction inputs if already present
				for (let i = 1; i <= 8; i++) {
					const el = document.getElementById('ExtSensTempCorr' + i);
					if (el && data.ExtSensTempCorr && data.ExtSensTempCorr.length >= i) {
						el.value = data.ExtSensTempCorr[i-1];
					}
				}
							// Render External Buttons (from holding registers)
			const extBtnContainer = document.getElementById('extBtnContainer');
			if (extBtnContainer) {
				let btnOut = '';
				for (let i = 0; i < 8; i++) {
					const idx = i + 1;
					const present = data.ExtBtnPresent && data.ExtBtnPresent[i];
					const mode = data.ExtBtnMode && data.ExtBtnMode[i];
					const tm = data.ExtBtnTm && data.ExtBtnTm[i];
					const active = data.ExtBtnActive && data.ExtBtnActive[i];
					btnOut += '<div class="section ext-section">';
					btnOut += '<h2>Ext Btn ' + idx + (present ? '' : ' (not present)') + '</h2>';
					btnOut += '<div class="field-row"><span class="field-label">Present:</span><input type="checkbox" id="ExtBtnPresent' + idx + '"' + (present ? ' checked' : '') + '></div>';
					btnOut += '<div class="field-row"><span class="field-label">Mode:</span><select id="ExtBtnMode' + idx + '"><option value="0">Boost</option><option value="1">Hood</option></select></div>';
					btnOut += '<div class="field-row"><span class="field-label">Timeout (s):</span><input type="number" id="ExtBtnTm' + idx + '" min="0" max="3600" step="1" value="' + (tm !== undefined ? tm : '') + '"></div>';
					btnOut += '<div class="field-row"><span class="field-label">Active:</span><input type="checkbox" id="ExtBtnActive' + idx + '"' + (active ? ' checked' : '') + '></div>';
					btnOut += '</div>';
				}
				extBtnContainer.innerHTML = btnOut;					// Attach change listeners for ExtBtnActive checkboxes so toggles post updates
					extBtnContainer.querySelectorAll('input[id^="ExtBtnActive"]').forEach((el) => {
						el.addEventListener('change', () => {
							const idx = el.id.replace('ExtBtnActive', '');
							postSingleField('ExtBtnActive' + idx, el.checked ? 1 : 0);
						});
					});				// Set select values explicitly
				for (let i = 0; i < 8; i++) {
					const idx = i + 1;
					const mEl = document.getElementById('ExtBtnMode' + idx);
					if (mEl && data.ExtBtnMode && data.ExtBtnMode[i] !== undefined) mEl.value = data.ExtBtnMode[i];
					const pEl = document.getElementById('ExtBtnPresent' + idx);
					if (pEl && data.ExtBtnPresent && data.ExtBtnPresent[i] !== undefined) pEl.checked = !!data.ExtBtnPresent[i];
					const tEl = document.getElementById('ExtBtnTm' + idx);
					if (tEl && data.ExtBtnTm && data.ExtBtnTm[i] !== undefined) tEl.value = data.ExtBtnTm[i];
				}
			}				showStatus('Values loaded successfully', 'success');
				// After loading initial values, attach auto-save listeners
				attachAutoSaveListeners();
			} catch (err) {
				showStatus('Error loading values: ' + err.message, 'error');
			}
		}

		// Submit form (kept for bulk apply when desired)
		document.getElementById('editForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			// Bulk apply still supported
			const formData = {
				FuncVentilation: parseInt(document.getElementById('FuncVentilation').value) || 0,
				FuncBoostTm: parseInt(document.getElementById('FuncBoostTm').value) || 0,
				FuncCirculationTm: parseInt(document.getElementById('FuncCirculationTm').value) || 0,
				FuncPartyTm: parseInt(document.getElementById('FuncPartyTm').value) || 0,
				FuncNightTm: parseInt(document.getElementById('FuncNightTm').value) || 0,
				FuncOverpressureTm: parseInt(document.getElementById('FuncOverpressureTm').value) || 0,
				CfgTempSet: parseFloat(document.getElementById('CfgTempSet').value) || 0,
				CfgHumiSet: parseFloat(document.getElementById('CfgHumiSet').value) || 0,
				CfgBypassEnable: document.getElementById('CfgBypassEnable').checked ? 1 : 0,
				CfgHeatingEnable: document.getElementById('CfgHeatingEnable').checked ? 1 : 0,
				CfgCoolingEnable: document.getElementById('CfgCoolingEnable').checked ? 1 : 0,
				CfgComfortEnable: document.getElementById('CfgComfortEnable').checked ? 1 : 0,
				FuncTimeProg: document.getElementById('FuncTimeProg').checked ? 1 : 0,
				FuncAntiradon: document.getElementById('FuncAntiradon').checked ? 1 : 0,
				VzvCBPriorityControl: parseInt(document.getElementById('VzvCBPriorityControl').value) || 0,
				VzvKitchenhoodNormallyOpen: document.getElementById('VzvKitchenhoodNormallyOpen').checked ? 1 : 0,
				VzvBoostVolumePerRun: parseInt(document.getElementById('VzvBoostVolumePerRun').value) || 0,
				VzvKitchenhoodNormallyOpenVolume: parseInt(document.getElementById('VzvKitchenhoodNormallyOpenVolume').value) || 0,
			};
			
			try {
				const res = await fetch('/api/write-holding', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(formData)
				});
				const result = await res.json();
				if (result.success) {
					showStatus('✅ Changes applied successfully!', 'success');
				} else {
					showStatus('❌ Error: ' + (result.error || 'Unknown error'), 'error');
				}
			} catch (err) {
				document.getElementById('status').textContent = '❌ Error writing values: ' + err.message;
			}
		});

		// helper: post a single field to the backend
		async function postSingleField(name, value) {
			try {
				const body = {};
				body[name] = value;
				const res = await fetch('/api/write-holding', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(body)
				});
				const result = await res.json();
				if (result.success) {
					showStatus('Saved ' + name, 'success');
				} else {
					showStatus('Error saving ' + name + ': ' + (result.error || 'unknown'), 'error');
				}
			} catch (err) {
				showStatus('Error saving ' + name + ': ' + err.message, 'error');
			}
		}

		// debounce helper
		function debounce(fn, wait) {
			let t;
			return function() {
				const args = arguments;
				const ctx = this;
				clearTimeout(t);
				t = setTimeout(function() { fn.apply(ctx, args); }, wait);
			};
		}

		// attach listeners to fields for immediate single-field writes
		function attachAutoSaveListeners() {
			const elems = document.querySelectorAll('#editForm input, #editForm select');
			elems.forEach(el => {
				// Avoid binding listeners multiple times
				if (el.dataset && el.dataset.autosaveBound) return;
				const id = el.id;
				if (!id) return;

				// Replace the element with a clean clone to remove any previously-attached
				// event listeners that may have been bound before. For <select> elements
				// we preserve child <option>s by cloning deeply; for others a shallow
				// clone is sufficient and avoids carrying old listeners.
				if (el.parentNode) {
					let clean;
					if (el.tagName === 'SELECT') {
						clean = el.cloneNode(true); // preserve options
					} else {
						clean = el.cloneNode(false);
					}
					// Copy current value/state
					clean.value = el.value;
					if (el.type === 'checkbox') clean.checked = el.checked;
					el.parentNode.replaceChild(clean, el);
					el = clean;
				}

				const send = () => {
					if (el.type === 'checkbox') {
						postSingleField(id, el.checked ? 1 : 0);
						return;
					}
					if (el.tagName === 'SELECT') {
						postSingleField(id, parseInt(el.value) || 0);
						return;
					}
					// Number inputs: support float or int depending on step
					if (el.type === 'number') {
						if (!el.value) return; // don't post empty
						if (el.step && el.step.indexOf('.') !== -1) {
							postSingleField(id, parseFloat(el.value) || 0);
						} else {
							postSingleField(id, parseInt(el.value) || 0);
						}
						return;
					}
					// fallback: send string value
					postSingleField(id, el.value);
				};

				if (el.type === 'number') {
					el.addEventListener('input', debounce(send, 400));
					el.addEventListener('change', send);
				} else {
					el.addEventListener('change', send);
				}
				// mark as bound so future calls won't add duplicate listeners
				el.dataset.autosaveBound = '1';
			});
		}

		function showStatus(msg, type) {
			const status = document.getElementById('status');
			status.className = 'status ' + type;
			status.textContent = msg;
			status.style.display = 'block';
			// auto-hide after 3s
			setTimeout(() => { status.style.display = 'none'; }, 3000);
		}

		// Load on page load
		loadValues();
		// Load ALFA values and refresh periodically
		async function loadAlfas() {
			try {
				const res = await fetch('/api/read-input');
				const data = await res.json();				// Main unit summary
				const main = document.getElementById('mainUnitContainer');
				let mainOut = '';
					mainOut += '<strong>Device ID:</strong> ' + (data.FactDeviceID !== undefined ? data.FactDeviceID : '—') + '<br>'; 
				mainOut += '<strong>Serial:</strong> ' + (data.FactSerialNum !== undefined ? data.FactSerialNum : '—') + '<br>';
				mainOut += '<strong>Ambient:</strong> ' + (data.TempAmbient !== undefined ? data.TempAmbient.toFixed(1) + '°C' : '—') + '<br>';
				mainOut += '<strong>Fresh:</strong> ' + (data.TempFresh !== undefined ? data.TempFresh.toFixed(1) + '°C' : '—') + '<br>';
				mainOut += '<strong>Indoor:</strong> ' + (data.TempIndoor !== undefined ? data.TempIndoor.toFixed(1) + '°C' : '—') + '<br>';
				mainOut += '<strong>Waste:</strong> ' + (data.TempWaste !== undefined ? data.TempWaste.toFixed(1) + '°C' : '—') + '<br>';
				mainOut += '<strong>Humi Ambient:</strong> ' + (data.HumiAmbient !== undefined ? data.HumiAmbient.toFixed(1) + '%' : '—') + '<br>';
				mainOut += '<strong>Humi Fresh:</strong> ' + (data.HumiFresh !== undefined ? data.HumiFresh.toFixed(1) + '%' : '—') + '<br>';
				mainOut += '<strong>Humi Indoor:</strong> ' + (data.HumiIndoor !== undefined ? data.HumiIndoor.toFixed(1) + '%' : '—') + '<br>';
				mainOut += '<strong>Humi Waste:</strong> ' + (data.HumiWaste !== undefined ? data.HumiWaste.toFixed(1) + '%' : '—') + '<br>';
				mainOut += '<strong>Filter Wear:</strong> ' + (data.FilterWear !== undefined ? data.FilterWear + '%' : '—') + '<br>';
				mainOut += '<strong>Air Flow:</strong> ' + (data.AirFlow !== undefined ? data.AirFlow : '—') + '<br>';
				mainOut += '<strong>Power:</strong> ' + (data.PowerConsumption !== undefined ? data.PowerConsumption : '—') + '<br>';
				mainOut += '<strong>Fan RPM Supply:</strong> ' + (data.FanRPMSupply !== undefined ? data.FanRPMSupply : '—') + '<br>';
				mainOut += '<strong>Fan RPM Exhaust:</strong> ' + (data.FanRPMExhaust !== undefined ? data.FanRPMExhaust : '—') + '<br>';
				main.innerHTML = mainOut;
				// Update ventilation visualization
			const formatVal = (n, decimals=1) => {
				if (n === undefined || n === null || isNaN(n)) return '—';
				const num = Number(n);
				const out = num.toFixed(decimals);
				return out.replace(/\.0+$/,'');
			};
			const setVent = (idBase, t, h) => {
				const tEl = document.getElementById(idBase + "-temp");
				const hEl = document.getElementById(idBase + "-humi");
				if (tEl) tEl.textContent = (t !== undefined && t !== null && !isNaN(t)) ? formatVal(t,1) + '°C' : '—';
				if (hEl) hEl.textContent = (h !== undefined && h !== null && !isNaN(h)) ? formatVal(h,1) : '—';
				};
				setVent('vent-outside', data.TempAmbient, data.HumiAmbient);
				setVent('vent-supply', data.TempFresh, data.HumiFresh);
				setVent('vent-exhaust', data.TempWaste, data.HumiWaste);
				setVent('vent-return', data.TempIndoor, data.HumiIndoor);
				const extContainer = document.getElementById('extSensContainer');
				if (extContainer) {
					let extOut = '';
					for (let i = 0; i < 8; i++) {
						const idx = i + 1;
						const present = data.ExtSensPresent && data.ExtSensPresent[i];
						const invalidate = data.ExtSensInvalidate && data.ExtSensInvalidate[i];
						extOut += '<div class="section">';
						extOut += '<h2>Ext Sens ' + idx + (present ? '' : ' (not present)') + '</h2>';
						extOut += '<div class="field-row"><span class="field-label">Present:</span><input type="checkbox" id="ExtSensPresent' + idx + '"' + (present ? ' checked' : '') + '></div>';
					// Invalidate: only show documented bits with names
					extOut += '<div class="field-row invalidate-line"><span class="field-label invalidate-label">Invalidate:</span>';
					const invalidateBits = [
						{bit:0, name: 'Invalid external sensor temperature value'},
						{bit:1, name: 'Invalid external sensor humidity value'},
						{bit:2, name: 'Invalid external sensor CO2 value'},
						{bit:3, name: 'Invalid external sensor floor temperature value'},
					];
					for (let ib = 0; ib < invalidateBits.length; ib++) {
						const b = invalidateBits[ib].bit;
						const label = invalidateBits[ib].name;
						const checked = (invalidate & (1 << b)) ? ' checked' : '';
						extOut += '<label class="invalidate-bit" title="' + label + '"><input type="checkbox" class="ExtSensInvalidate' + idx + '_bit" data-sensor="' + idx + '" data-bit="' + b + '" aria-label="' + label + '"' + checked + '></label>';
						}
					extOut += '</div>';
					// Editable live values
					extOut += '<div class="field-row"><span class="field-label">Temp:</span><input type="number" id="ExtSensTemp' + idx + '" step="0.1" min="-50" max="100" value="' + (data.ExtSensTemp && data.ExtSensTemp[i] !== undefined ? data.ExtSensTemp[i].toFixed(1) : '') + '"> °C</div>';
					extOut += '<div class="field-row"><span class="field-label">RH:</span><input type="number" id="ExtSensRH' + idx + '" step="1" min="0" max="100" value="' + (data.ExtSensRH && data.ExtSensRH[i] !== undefined ? data.ExtSensRH[i] : '') + '"> %</div>';
					extOut += '<div class="field-row"><span class="field-label">CO2:</span><input type="number" id="ExtSensCo2' + idx + '" step="1" min="0" max="10000" value="' + (data.ExtSensCo2 && data.ExtSensCo2[i] !== undefined ? data.ExtSensCo2[i] : '') + '"> ppm</div>';
					extOut += '<div class="field-row"><span class="field-label">Floor:</span><input type="number" id="ExtSensTFloor' + idx + '" step="0.1" min="-50" max="100" value="' + (data.ExtSensTFloor && data.ExtSensTFloor[i] !== undefined ? data.ExtSensTFloor[i].toFixed(1) : '') + '"> °C</div>';
					extOut += '<div class="field-row"><span class="field-label">Correction:</span><input type="number" id="ExtSensTempCorr' + idx + '" step="0.1" min="-50" max="50"></div>';
					extOut += '</div>';
					}
					extContainer.innerHTML = extOut;
					// populate correction inputs from cached holding data
					if (window.holdingData && window.holdingData.ExtSensTempCorr) {
						for (let i = 1; i <= 8; i++) {
							const el = document.getElementById('ExtSensTempCorr' + i);
							if (el && window.holdingData.ExtSensTempCorr.length >= i) el.value = window.holdingData.ExtSensTempCorr[i-1];
						}
					}
					// attach invalidate bit listeners (recomputed mask write)
					for (let si = 1; si <= 8; si++) {
						const bits = document.querySelectorAll('.ExtSensInvalidate' + si + '_bit');
						if (!bits) continue;
						bits.forEach(cb => {
							if (cb.dataset && cb.dataset.invalidateBound) return;
							cb.addEventListener('change', () => {
								let mask = 0;
								bits.forEach(b => {
									if (b.checked) mask |= (1 << parseInt(b.dataset.bit));
								});
								postSingleField('ExtSensInvalidate' + si, mask);
							});
							cb.dataset.invalidateBound = '1';
						});
					}
					// Ensure listeners for newly created inputs
					attachAutoSaveListeners();
				}
				const container = document.getElementById('alfaContainer');
				let out = '';
				if (!data.AlfaMBAddress) {
					container.textContent = 'No ALFA data available';
					return;
				}
				for (let i = 0; i < data.AlfaMBAddress.length; i++) {
					if (!data.AlfaMBAddress[i]) continue; // not present
					const idx = i + 1;
						out += '<div class="section"><h2>ALFA ' + idx + '</h2>';
				out += '<strong>Address:</strong> ' + data.AlfaMBAddress[i] + '<br>';
				out += '<strong>Temp:</strong> ' + (data.AlfaTemp && data.AlfaTemp[i] !== undefined ? data.AlfaTemp[i].toFixed(1) + '°C' : '—') + '<br>';
				out += '<strong>Humi:</strong> ' + (data.AlfaHumi && data.AlfaHumi[i] !== undefined ? data.AlfaHumi[i].toFixed(1) + '%' : '—') + '<br>';
				out += '<strong>CO2:</strong> ' + (data.AlfaCo2 && data.AlfaCo2[i] !== undefined ? data.AlfaCo2[i].toFixed(1) + 'ppm' : '—') + '<br>';
				out += '<strong>NTC Temp:</strong> ' + (data.AlfaNTCTemp && data.AlfaNTCTemp[i] !== undefined ? data.AlfaNTCTemp[i].toFixed(1) + '°C' : '—') + '<br>';
				out += '</div>';
				}
				container.innerHTML = out || 'No ALFA controllers present';
					// populate ext sensor correction inputs from cached holding data (if any)
					if (window.holdingData && window.holdingData.ExtSensTempCorr) {
						for (let i = 1; i <= 8; i++) {
							const el = document.getElementById('ExtSensTempCorr' + i);
							if (el && window.holdingData.ExtSensTempCorr.length >= i) el.value = window.holdingData.ExtSensTempCorr[i-1];
						}
					}
					// Re-attach listeners to newly-created inputs
					attachAutoSaveListeners();
			} catch (err) {
				document.getElementById('alfaContainer').textContent = 'Error loading ALFA: ' + err.message;
			}
		}
		// initial load and periodic refresh every 5s
		loadAlfas();
		setInterval(loadAlfas, 5000);
	</script>
</body>
</html>
